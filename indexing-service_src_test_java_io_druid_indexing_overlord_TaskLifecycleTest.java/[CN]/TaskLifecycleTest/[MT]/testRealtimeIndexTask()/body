{
  monitorScheduler.addMonitor(EasyMock.anyObject(Monitor.class));
  EasyMock.expectLastCall().atLeastOnce();
  monitorScheduler.removeMonitor(EasyMock.anyObject(Monitor.class));
  EasyMock.expectLastCall().anyTimes();
  EasyMock.replay(monitorScheduler,queryRunnerFactoryConglomerate);
  RealtimeIndexTask realtimeIndexTask=giveMeARealtimeIndexTask();
  final String taskId=realtimeIndexTask.getId();
  tq.add(realtimeIndexTask);
  Assert.assertTrue(publishCountDown.await(1000,TimeUnit.MILLISECONDS));
  segmentCallbacks.get(0).segmentAdded(new DruidServerMetadata("dummy","dummy_host",0,"historical","dummy_tier",0),mdc.getPublished().iterator().next());
  while (tsqa.getStatus(taskId).get().isRunnable()) {
    Thread.sleep(10);
  }
  Assert.assertTrue("Task should be in Success state",tsqa.getStatus(taskId).get().isSuccess());
  Assert.assertEquals(1,announcedSinks);
  Assert.assertEquals(1,pushedSegments);
  Assert.assertEquals(1,mdc.getPublished().size());
  DataSegment segment=mdc.getPublished().iterator().next();
  Assert.assertEquals("test_ds",segment.getDataSource());
  Assert.assertEquals(ImmutableList.of("dim1","dim2"),segment.getDimensions());
  Assert.assertEquals(new Interval(now.toString("YYYY-MM-dd") + "/" + now.plusDays(1).toString("YYYY-MM-dd")),segment.getInterval());
  Assert.assertEquals(ImmutableList.of("count"),segment.getMetrics());
  EasyMock.verify(monitorScheduler,queryRunnerFactoryConglomerate);
}
