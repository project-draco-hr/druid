{
  final ServiceInstance<T> instance;
synchronized (monitor) {
    if (instanceMap.containsKey(service)) {
      log.warn("Ignoring request to announce service[%s]",service);
      return;
    }
 else {
      instance=instanceFactory.create(service);
      instanceMap.put(service,instance);
    }
  }
  try {
    log.info("Announcing service[%s]",service);
    discovery.registerService(instance);
  }
 catch (  Exception e) {
    log.warn("Failed to announce service[%s]",service);
synchronized (monitor) {
      instanceMap.remove(service);
    }
  }
}
