{
  final UpdateStream updateStream=updateStreamFactory.build();
  final ExecutorService service=Executors.newSingleThreadExecutor();
  service.submit(updateStream);
  return new Firehose(){
    Map<String,Object> map;
    private final Runnable doNothingRunnable=Runnables.getNoopRunnable();
    @Override public boolean hasMore(){
      try {
        map=updateStream.pollFromQueue();
        return map != null;
      }
 catch (      Exception e) {
        throw Throwables.propagate(e);
      }
    }
    @Override public InputRow nextRow(){
      try {
        DateTime date=TimestampParser.createTimestampParser(timeFormat).apply(map.get(updateStream.getNewTimeDimension()).toString());
        return new MapBasedInputRow(date.getMillis(),new ArrayList(map.keySet()),map);
      }
 catch (      Exception e) {
        throw Throwables.propagate(e);
      }
    }
    @Override public Runnable commit(){
      return doNothingRunnable;
    }
    @Override public void close() throws IOException {
      service.shutdown();
    }
  }
;
}
