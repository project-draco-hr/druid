{
  final CacheStrategy strategy=toolChest.getCacheStrategy(query);
  final boolean populateCache=query.getContextPopulateCache(true) && strategy != null && cacheConfig.isPopulateCache() && !(cache instanceof MapCache);
  if (populateCache) {
    Sequence<T> results=base.run(query);
    Cache.NamedKey key=CacheUtil.computeSegmentCacheKey(segmentIdentifier,segmentDescriptor,strategy.computeCacheKey(query));
    ArrayList<T> resultAsList=Sequences.toList(results,new ArrayList<T>());
    CacheUtil.populate(cache,mapper,key,Lists.transform(resultAsList,strategy.prepareForCache()));
    return Sequences.simple(resultAsList);
  }
 else {
    return base.run(query);
  }
}
