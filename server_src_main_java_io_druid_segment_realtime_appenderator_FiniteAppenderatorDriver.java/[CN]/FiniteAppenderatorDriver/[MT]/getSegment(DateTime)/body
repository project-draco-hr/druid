{
synchronized (activeSegments) {
    final SegmentIdentifier existing=getActiveSegment(timestamp);
    if (existing != null) {
      return existing;
    }
 else {
      final SegmentIdentifier newSegment=segmentAllocator.allocate(timestamp,lastSegmentId);
      if (newSegment != null) {
        final Long key=newSegment.getInterval().getStartMillis();
        final SegmentIdentifier conflicting=activeSegments.get(key);
        if (conflicting != null) {
          throw new ISE("WTF?! Allocated segment[%s] which conflicts with existing segment[%s].",newSegment,conflicting);
        }
        log.info("New segment[%s].",newSegment);
        activeSegments.put(key,newSegment);
        lastSegmentId=newSegment.getIdentifierAsString();
      }
 else {
        log.warn("Cannot allocate segment for timestamp[%s]. ",timestamp);
      }
      return newSegment;
    }
  }
}
