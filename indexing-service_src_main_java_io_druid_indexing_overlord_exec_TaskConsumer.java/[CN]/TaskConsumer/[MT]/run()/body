{
  try {
    while (!Thread.currentThread().isInterrupted()) {
      final Task task;
      try {
        task=queue.take();
      }
 catch (      InterruptedException e) {
        log.info("Interrupted while waiting for new work");
        Thread.currentThread().interrupt();
        break;
      }
      try {
        handoff(task);
      }
 catch (      Exception e) {
        log.makeAlert(e,"Failed to hand off task").addData("task",task.getId()).addData("type",task.getType()).addData("dataSource",task.getDataSource()).addData("interval",task.getImplicitLockInterval()).emit();
        if (!shutdown) {
          queue.notify(task,TaskStatus.failure(task.getId()));
        }
      }
    }
  }
 catch (  Exception e) {
    log.error(e,"Uncaught exception while consuming tasks");
    throw Throwables.propagate(e);
  }
}
