{
  return FunctionalIterable.create(index.facts.entrySet()).transform(new Function<Map.Entry<IncrementalIndex.TimeAndDims,Aggregator[]>,Rowboat>(){
    int count=0;
    @Override public Rowboat apply(    @Nullable Map.Entry<IncrementalIndex.TimeAndDims,Aggregator[]> input){
      final IncrementalIndex.TimeAndDims timeAndDims=input.getKey();
      final String[][] dimValues=timeAndDims.getDims();
      final Aggregator[] aggs=input.getValue();
      int[][] dims=new int[dimValues.length][];
      for (      String dimension : dimensions) {
        int dimIndex=index.dimensionOrder.get(dimension);
        final IncrementalIndex.DimDim dimDim=index.dimValues.get(dimension);
        dimDim.sort();
        if (dimIndex >= dimValues.length || dimValues[dimIndex] == null) {
          continue;
        }
        dims[dimIndex]=new int[dimValues[dimIndex].length];
        if (dimIndex >= dims.length || dims[dimIndex] == null) {
          continue;
        }
        for (int i=0; i < dimValues[dimIndex].length; ++i) {
          dims[dimIndex][i]=dimDim.getSortedId(dimValues[dimIndex][i]);
        }
      }
      Object[] metrics=new Object[aggs.length];
      for (int i=0; i < aggs.length; i++) {
        metrics[i]=aggs[i].get();
      }
      return new Rowboat(timeAndDims.getTimestamp(),dims,metrics,count++);
    }
  }
);
}
