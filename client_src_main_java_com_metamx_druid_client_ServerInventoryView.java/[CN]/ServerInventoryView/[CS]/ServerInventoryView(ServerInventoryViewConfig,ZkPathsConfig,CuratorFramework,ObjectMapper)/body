{
  inventoryManager=new CuratorInventoryManager<DruidServer,DataSegment>(curator,new InventoryManagerConfig(){
    @Override public String getContainerPath(){
      return zkPaths.getAnnouncementsPath();
    }
    @Override public String getInventoryPath(){
      return zkPaths.getServedSegmentsPath();
    }
  }
,Execs.singleThreaded("ServerInventoryView-%s"),new CuratorInventoryManagerStrategy<DruidServer,DataSegment>(){
    @Override public DruidServer deserializeContainer(    byte[] bytes){
      try {
        return jsonMapper.readValue(bytes,DruidServer.class);
      }
 catch (      IOException e) {
        throw Throwables.propagate(e);
      }
    }
    @Override public byte[] serializeContainer(    DruidServer container){
      try {
        return jsonMapper.writeValueAsBytes(container);
      }
 catch (      JsonProcessingException e) {
        throw Throwables.propagate(e);
      }
    }
    @Override public DataSegment deserializeInventory(    byte[] bytes){
      try {
        return jsonMapper.readValue(bytes,DataSegment.class);
      }
 catch (      IOException e) {
        throw Throwables.propagate(e);
      }
    }
    @Override public byte[] serializeInventory(    DataSegment inventory){
      try {
        return jsonMapper.writeValueAsBytes(inventory);
      }
 catch (      JsonProcessingException e) {
        throw Throwables.propagate(e);
      }
    }
    @Override public void newContainer(    DruidServer container){
      log.info("New Server[%s]",container);
    }
    @Override public void deadContainer(    DruidServer deadContainer){
      log.info("Server Disdappeared[%s]",deadContainer);
      runServerCallbacks(deadContainer);
    }
    @Override public DruidServer updateContainer(    DruidServer oldContainer,    DruidServer newContainer){
      return newContainer.addDataSegments(oldContainer);
    }
    @Override public DruidServer addInventory(    final DruidServer container,    String inventoryKey,    final DataSegment inventory){
      log.info("Server[%s] added segment[%s]",container.getName(),inventory);
      final DruidServer retVal=container.addDataSegment(inventoryKey,inventory);
      runSegmentCallbacks(new Function<SegmentCallback,CallbackAction>(){
        @Override public CallbackAction apply(        SegmentCallback input){
          return input.segmentAdded(container,inventory);
        }
      }
);
      return retVal;
    }
    @Override public DruidServer removeInventory(    final DruidServer container,    String inventoryKey){
      log.info("Server[%s] removed segment[%s]",container.getName(),inventoryKey);
      final DataSegment segment=container.getSegment(inventoryKey);
      final DruidServer retVal=container.removeDataSegment(inventoryKey);
      runSegmentCallbacks(new Function<SegmentCallback,CallbackAction>(){
        @Override public CallbackAction apply(        SegmentCallback input){
          return input.segmentRemoved(container,segment);
        }
      }
);
      removedSegments.put(inventoryKey,config.getRemovedSegmentLifetime());
      return retVal;
    }
  }
);
}
