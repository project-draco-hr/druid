{
  Sequence<Row> result;
  DataSource dataSource=query.getDataSource();
  if (dataSource instanceof QueryDataSource) {
    GroupByQuery subquery;
    try {
      subquery=(GroupByQuery)((QueryDataSource)dataSource).getQuery();
    }
 catch (    ClassCastException e) {
      throw new UnsupportedOperationException("Subqueries must be of type 'group by'");
    }
    Sequence<Row> subqueryResult=mergeGroupByResults(subquery,runner);
    final GroupByQuery.Builder builder=new GroupByQuery.Builder(subquery);
    for (    PostAggregator postAggregator : subquery.getPostAggregatorSpecs()) {
      builder.addAggregator(new DoubleSumAggregatorFactory(postAggregator.getName(),postAggregator.getName()));
    }
    IncrementalIndexStorageAdapter adapter=new IncrementalIndexStorageAdapter(makeIncrementalIndex(builder.build(),subqueryResult));
    result=engine.process(query,adapter);
  }
 else {
    result=runner.run(query);
  }
  return postAggregate(query,makeIncrementalIndex(query,result));
}
