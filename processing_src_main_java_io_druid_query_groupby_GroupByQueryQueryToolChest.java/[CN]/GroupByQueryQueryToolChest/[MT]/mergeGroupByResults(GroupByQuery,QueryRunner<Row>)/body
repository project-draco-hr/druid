{
  DataSource dataSource=query.getDataSource();
  final IncrementalIndex index;
  if (dataSource instanceof QueryDataSource) {
    GroupByQuery subquery;
    try {
      subquery=(GroupByQuery)((QueryDataSource)dataSource).getQuery();
    }
 catch (    ClassCastException e) {
      throw new UnsupportedOperationException("Subqueries must be of type 'group by'");
    }
    Sequence<Row> subqueryResult=mergeGroupByResults(subquery,runner);
    final IncrementalIndex subQueryResultIndex=makeIncrementalIndex(subquery,subqueryResult);
    Sequence<Row> result=engine.process(query,new IncrementalIndexStorageAdapter(subQueryResultIndex));
    index=makeIncrementalIndex(query,result);
    subQueryResultIndex.close();
  }
 else {
    index=makeIncrementalIndex(query,runner.run(query));
  }
  return new ResourceClosingSequence<Row>(postAggregate(query,index),index);
}
