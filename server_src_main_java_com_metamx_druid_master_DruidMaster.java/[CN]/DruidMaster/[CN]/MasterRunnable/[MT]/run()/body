{
  try {
synchronized (lock) {
      final LeaderLatch latch=leaderLatch.get();
      if (latch == null || !latch.hasLeadership()) {
        log.info("[%s] is master, not me.  Phooey.",latch == null ? null : latch.getLeader().getId());
        stopBeingMaster();
        return;
      }
    }
    List<Boolean> allStarted=Arrays.asList(databaseSegmentManager.isStarted(),serverInventoryThingie.isStarted());
    for (    Boolean aBoolean : allStarted) {
      if (!aBoolean) {
        log.error("InventoryManagers not started[%s]",allStarted);
        stopBeingMaster();
        return;
      }
    }
    DruidMasterRuntimeParams params=DruidMasterRuntimeParams.newBuilder().withStartTime(startTime).withDatasources(databaseSegmentManager.getInventory()).withMillisToWaitBeforeDeleting(config.getMillisToWaitBeforeDeleting()).withEmitter(emitter).withMergeBytesLimit(config.getMergeBytesLimit()).withMergeSegmentsLimit(config.getMergeSegmentsLimit()).withMaxSegmentsToMove(config.getMaxSegmentsToMove()).build();
    for (    DruidMasterHelper helper : helpers) {
      params=helper.run(params);
    }
  }
 catch (  Exception e) {
    log.makeAlert(e,"Caught exception, ignoring so that schedule keeps going.").emit();
  }
}
