{
  giant.lock();
  try {
    Preconditions.checkState(!active,"queue must be stopped");
    log.info("Bootstrapping queue (and associated lockbox)");
    queue.clear();
    taskLockbox.clear();
    final Multimap<TaskLock,Task> tasksByLock=ArrayListMultimap.create();
    for (    final Task task : taskStorage.getActiveTasks()) {
      try {
        final List<TaskLock> taskLocks=taskStorage.getLocks(task.getId());
        queue.add(task);
        for (        final TaskLock taskLock : taskLocks) {
          tasksByLock.put(taskLock,task);
        }
      }
 catch (      Exception e) {
        log.makeAlert("Failed to bootstrap task").addData("task",task.getId()).emit();
        throw Throwables.propagate(e);
      }
    }
    final Ordering<Map.Entry<TaskLock,Task>> byVersionOrdering=new Ordering<Map.Entry<TaskLock,Task>>(){
      @Override public int compare(      Map.Entry<TaskLock,Task> left,      Map.Entry<TaskLock,Task> right){
        return left.getKey().getVersion().compareTo(right.getKey().getVersion());
      }
    }
;
    for (    final Map.Entry<TaskLock,Task> taskAndLock : byVersionOrdering.sortedCopy(tasksByLock.entries())) {
      final Task task=taskAndLock.getValue();
      final TaskLock savedTaskLock=taskAndLock.getKey();
      final Optional<TaskLock> acquiredTaskLock=taskLockbox.tryLock(task,savedTaskLock.getInterval(),Optional.of(savedTaskLock.getVersion()));
      if (acquiredTaskLock.isPresent() && savedTaskLock.getVersion().equals(acquiredTaskLock.get().getVersion())) {
        log.info("Reacquired lock on interval[%s] version[%s] for task: %s",savedTaskLock.getInterval(),savedTaskLock.getVersion(),task.getId());
      }
 else       if (acquiredTaskLock.isPresent()) {
        log.info("Could not reacquire lock on interval[%s] version[%s] (got version[%s] instead) for task: %s",savedTaskLock.getInterval(),savedTaskLock.getVersion(),acquiredTaskLock.get().getVersion(),task.getId());
      }
 else {
        log.info("Could not reacquire lock on interval[%s] version[%s] for task: %s",savedTaskLock.getInterval(),savedTaskLock.getVersion(),task.getId());
      }
    }
    log.info("Bootstrapped %,d tasks with %,d locks. Ready to go!",queue.size(),tasksByLock.keySet().size());
  }
  finally {
    giant.unlock();
  }
}
