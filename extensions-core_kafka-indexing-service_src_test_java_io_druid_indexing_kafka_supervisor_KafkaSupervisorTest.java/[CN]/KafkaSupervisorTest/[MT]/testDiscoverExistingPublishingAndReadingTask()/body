{
  final TaskLocation location1=new TaskLocation("testHost",1234);
  final TaskLocation location2=new TaskLocation("testHost2",145);
  final DateTime startTime=new DateTime();
  supervisor=getSupervisor(1,1,true,"PT1H");
  addSomeEvents(1);
  Task id1=createKafkaIndexTask("id1",DATASOURCE,"sequenceName-0",new KafkaPartitions("topic",ImmutableMap.of(0,0L,1,0L,2,0L)),new KafkaPartitions("topic",ImmutableMap.of(0,Long.MAX_VALUE,1,Long.MAX_VALUE,2,Long.MAX_VALUE)));
  Task id2=createKafkaIndexTask("id2",DATASOURCE,"sequenceName-0",new KafkaPartitions("topic",ImmutableMap.of(0,10L,1,20L,2,30L)),new KafkaPartitions("topic",ImmutableMap.of(0,Long.MAX_VALUE,1,Long.MAX_VALUE,2,Long.MAX_VALUE)));
  Collection workItems=new ArrayList<>();
  workItems.add(new TestTaskRunnerWorkItem(id1.getId(),null,location1));
  workItems.add(new TestTaskRunnerWorkItem(id2.getId(),null,location2));
  expect(taskMaster.getTaskQueue()).andReturn(Optional.of(taskQueue)).anyTimes();
  expect(taskMaster.getTaskRunner()).andReturn(Optional.of(taskRunner)).anyTimes();
  expect(taskRunner.getRunningTasks()).andReturn(workItems).anyTimes();
  expect(taskStorage.getActiveTasks()).andReturn(ImmutableList.of(id1,id2)).anyTimes();
  expect(taskStorage.getStatus("id1")).andReturn(Optional.of(TaskStatus.running("id1"))).anyTimes();
  expect(taskStorage.getStatus("id2")).andReturn(Optional.of(TaskStatus.running("id2"))).anyTimes();
  expect(taskStorage.getTask("id1")).andReturn(Optional.of(id1)).anyTimes();
  expect(taskStorage.getTask("id2")).andReturn(Optional.of(id2)).anyTimes();
  expect(indexerMetadataStorageCoordinator.getDataSourceMetadata(DATASOURCE)).andReturn(new KafkaDataSourceMetadata(null)).anyTimes();
  expect(taskClient.getStatus("id1")).andReturn(KafkaIndexTask.Status.PUBLISHING);
  expect(taskClient.getStatus("id2")).andReturn(KafkaIndexTask.Status.READING);
  expect(taskClient.getStartTime("id2",false)).andReturn(startTime);
  expect(taskClient.getCurrentOffsets("id1",false)).andReturn(ImmutableMap.of(0,10L,1,20L,2,30L));
  expect(taskClient.getCurrentOffsets("id1",true)).andReturn(ImmutableMap.of(0,10L,1,20L,2,30L));
  expect(taskClient.getCurrentOffsets("id2",false)).andReturn(ImmutableMap.of(0,40L,1,50L,2,60L));
  taskRunner.registerListener(anyObject(TaskRunnerListener.class),anyObject(Executor.class));
  replayAll();
  supervisor.start();
  supervisor.runInternal();
  SupervisorReport report=supervisor.getStatus();
  verifyAll();
  Assert.assertEquals(DATASOURCE,report.getId());
  Assert.assertTrue(report.getPayload() instanceof KafkaSupervisorReport.KafkaSupervisorReportPayload);
  KafkaSupervisorReport.KafkaSupervisorReportPayload payload=(KafkaSupervisorReport.KafkaSupervisorReportPayload)report.getPayload();
  Assert.assertEquals(DATASOURCE,payload.getDataSource());
  Assert.assertEquals(3600L,(long)payload.getDurationSeconds());
  Assert.assertEquals(NUM_PARTITIONS,(int)payload.getPartitions());
  Assert.assertEquals(1,(int)payload.getReplicas());
  Assert.assertEquals(KAFKA_TOPIC,payload.getTopic());
  Assert.assertEquals(1,payload.getActiveTasks().size());
  Assert.assertEquals(1,payload.getPublishingTasks().size());
  KafkaSupervisorReport.TaskReportData activeReport=payload.getActiveTasks().get(0);
  KafkaSupervisorReport.TaskReportData publishingReport=payload.getPublishingTasks().get(0);
  Assert.assertEquals("id2",activeReport.getId());
  Assert.assertEquals(startTime,activeReport.getStartTime());
  Assert.assertEquals(ImmutableMap.of(0,10L,1,20L,2,30L),activeReport.getStartingOffsets());
  Assert.assertEquals(ImmutableMap.of(0,40L,1,50L,2,60L),activeReport.getCurrentOffsets());
  Assert.assertEquals("id1",publishingReport.getId());
  Assert.assertEquals(ImmutableMap.of(0,0L,1,0L,2,0L),publishingReport.getStartingOffsets());
  Assert.assertEquals(ImmutableMap.of(0,10L,1,20L,2,30L),publishingReport.getCurrentOffsets());
}
