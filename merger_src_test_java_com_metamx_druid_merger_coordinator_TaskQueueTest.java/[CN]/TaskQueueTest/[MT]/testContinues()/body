{
  final TaskStorage ts=new LocalTaskStorage();
  final TaskLockbox tl=new TaskLockbox(ts);
  final TaskQueue tq=newTaskQueue(ts,tl);
  final TaskToolbox tb=new TaskToolbox(null,new LocalTaskActionClient(ts,new TaskActionToolbox(tq,tl,null,null)),null,null,null,null,null);
  final Task t0=newTask("T0","G0","bar",new Interval("2011/P1Y"));
  final Task t1=newContinuedTask("T1","G1","bar",new Interval("2013/P1Y"),Lists.newArrayList(t0));
  tq.add(t1);
  Assert.assertTrue("T0 isPresent (#1)",!ts.getStatus("T0").isPresent());
  Assert.assertTrue("T1 isPresent (#1)",ts.getStatus("T1").isPresent());
  Assert.assertTrue("T1 isRunnable (#1)",ts.getStatus("T1").get().isRunnable());
  Assert.assertTrue("T1 isComplete (#1)",!ts.getStatus("T1").get().isComplete());
  Assert.assertEquals("poll #1","T1",tq.poll().getId());
  Assert.assertNull("poll #2",tq.poll());
  tq.notify(t1,t1.run(tb));
  Assert.assertTrue("T0 isPresent (#2)",ts.getStatus("T0").isPresent());
  Assert.assertTrue("T0 isRunnable (#2)",ts.getStatus("T0").get().isRunnable());
  Assert.assertTrue("T0 isComplete (#2)",!ts.getStatus("T0").get().isComplete());
  Assert.assertTrue("T1 isPresent (#2)",ts.getStatus("T1").isPresent());
  Assert.assertTrue("T1 isRunnable (#2)",!ts.getStatus("T1").get().isRunnable());
  Assert.assertTrue("T1 isComplete (#2)",ts.getStatus("T1").get().isComplete());
  Assert.assertEquals("poll #3","T0",tq.poll().getId());
  Assert.assertNull("poll #4",tq.poll());
  tq.notify(t0,t0.run(tb));
  Assert.assertTrue("T0 isPresent (#3)",ts.getStatus("T0").isPresent());
  Assert.assertTrue("T0 isRunnable (#3)",!ts.getStatus("T0").get().isRunnable());
  Assert.assertTrue("T0 isComplete (#3)",ts.getStatus("T0").get().isComplete());
  Assert.assertTrue("T1 isPresent (#3)",ts.getStatus("T1").isPresent());
  Assert.assertTrue("T1 isRunnable (#3)",!ts.getStatus("T1").get().isRunnable());
  Assert.assertTrue("T1 isComplete (#3)",ts.getStatus("T1").get().isComplete());
  Assert.assertNull("poll #5",tq.poll());
}
