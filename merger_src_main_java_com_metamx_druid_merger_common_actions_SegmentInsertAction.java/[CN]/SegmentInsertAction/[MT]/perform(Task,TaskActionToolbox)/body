{
  if (!toolbox.taskLockCoversSegments(task,segments,false)) {
    throw new ISE("Segments not covered by locks for task[%s]: %s",task.getId(),segments);
  }
  final Set<DataSegment> retVal=toolbox.getMergerDBCoordinator().announceHistoricalSegments(segments);
  final ServiceMetricEvent.Builder metricBuilder=new ServiceMetricEvent.Builder().setUser2(task.getDataSource()).setUser4(task.getType());
  for (  DataSegment segment : segments) {
    metricBuilder.setUser5(segment.getInterval().toString());
    toolbox.getEmitter().emit(metricBuilder.build("indexer/segment/bytes",segment.getSize()));
  }
  return retVal;
}
