{
  this.taskQueue=taskQueue;
  this.taskToolboxFactory=taskToolboxFactory;
  this.leaderSelector=new LeaderSelector(curator,indexerCoordinatorConfig.getLeaderLatchPath(),new LeaderSelectorListener(){
    @Override public void takeLeadership(    CuratorFramework client) throws Exception {
      giant.lock();
      try {
        log.info("By the power of Grayskull, I have the power!");
        final TaskRunner taskRunner=runnerFactory.build();
        theRunner=taskRunner;
        final ResourceManagementScheduler scheduler=managementSchedulerFactory.build(theRunner);
        final TaskConsumer taskConsumer=new TaskConsumer(taskQueue,taskRunner,taskToolboxFactory,emitter);
        taskQueue.bootstrap();
        final Lifecycle leaderLifecycle=new Lifecycle();
        leaderLifecycle.addManagedInstance(taskQueue);
        leaderLifecycle.addManagedInstance(taskRunner);
        Initialization.makeServiceDiscoveryClient(curator,serviceDiscoveryConfig,leaderLifecycle);
        leaderLifecycle.addManagedInstance(taskConsumer);
        leaderLifecycle.addManagedInstance(scheduler);
        leading=true;
        try {
          leaderLifecycle.start();
          while (leading) {
            mayBeStopped.await();
          }
        }
  finally {
          log.info("Bowing out!");
          leaderLifecycle.stop();
        }
      }
 catch (      Exception e) {
        log.makeAlert(e,"Failed to lead").emit();
        throw Throwables.propagate(e);
      }
 finally {
        giant.unlock();
      }
    }
    @Override public void stateChanged(    CuratorFramework client,    ConnectionState newState){
      if (newState == ConnectionState.LOST || newState == ConnectionState.SUSPENDED) {
        stopLeading();
      }
    }
  }
);
  leaderSelector.setId(indexerCoordinatorConfig.getServerName());
  leaderSelector.autoRequeue();
}
