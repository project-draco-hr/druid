{
  this.taskQueue=taskQueue;
  this.taskActionClientFactory=taskActionClientFactory;
  this.leaderSelector=new LeaderSelector(curator,indexerCoordinatorConfig.getIndexerLeaderLatchPath(),new LeaderSelectorListener(){
    @Override public void takeLeadership(    CuratorFramework client) throws Exception {
      giant.lock();
      try {
        log.info("By the power of Grayskull, I have the power!");
        taskRunner=runnerFactory.build();
        resourceManagementScheduler=managementSchedulerFactory.build(taskRunner);
        final TaskConsumer taskConsumer=new TaskConsumer(taskQueue,taskRunner,taskActionClientFactory,emitter);
        taskQueue.bootstrap();
        final Lifecycle leaderLifecycle=new Lifecycle();
        leaderLifecycle.addManagedInstance(taskQueue);
        leaderLifecycle.addManagedInstance(taskRunner);
        Initialization.announceDefaultService(serviceDiscoveryConfig,serviceAnnouncer,leaderLifecycle);
        leaderLifecycle.addManagedInstance(taskConsumer);
        leaderLifecycle.addManagedInstance(resourceManagementScheduler);
        try {
          leaderLifecycle.start();
          leading=true;
          while (leading && !Thread.currentThread().isInterrupted()) {
            mayBeStopped.await();
          }
        }
 catch (        InterruptedException e) {
        }
 finally {
          log.info("Bowing out!");
          stopLeading();
          leaderLifecycle.stop();
        }
      }
 catch (      Exception e) {
        log.makeAlert(e,"Failed to lead").emit();
        throw Throwables.propagate(e);
      }
 finally {
        giant.unlock();
      }
    }
    @Override public void stateChanged(    CuratorFramework client,    ConnectionState newState){
      if (newState == ConnectionState.LOST || newState == ConnectionState.SUSPENDED) {
        stopLeading();
      }
    }
  }
);
  leaderSelector.setId(indexerCoordinatorConfig.getServerName());
  leaderSelector.autoRequeue();
}
