{
  final Map<String,Integer> expectedSegmentsInCluster=Maps.newHashMap();
  final DateTime now=new DateTime();
  for (  DataSegment segment : getAvailableDataSegments()) {
    List<Rule> rules=databaseRuleManager.getRulesWithDefault(segment.getDataSource());
    for (    Rule rule : rules) {
      if (rule instanceof LoadRule && rule.appliesTo(segment,now)) {
        Integer count=expectedSegmentsInCluster.get(segment.getIdentifier());
        if (count == null) {
          count=0;
        }
        expectedSegmentsInCluster.put(segment.getIdentifier(),count + ((LoadRule)rule).getReplicants());
        break;
      }
    }
  }
  Map<String,Integer> segmentsInCluster=Maps.newHashMap();
  for (  DruidServer druidServer : serverInventoryView.getInventory()) {
    for (    DataSegment segment : druidServer.getSegments().values()) {
      Integer count=segmentsInCluster.get(segment.getIdentifier());
      if (count == null) {
        count=0;
      }
      segmentsInCluster.put(segment.getIdentifier(),count + 1);
    }
  }
  Map<String,Double> loadStatus=Maps.newHashMap();
  for (  Map.Entry<String,Integer> entry : expectedSegmentsInCluster.entrySet()) {
    Integer actual=segmentsInCluster.get(entry.getKey());
    loadStatus.put(entry.getKey(),100 * (actual == null ? 0.0D : (double)actual) / entry.getValue());
  }
  return loadStatus;
}
