{
  try (final BackgroundSegmentAnnouncer backgroundSegmentAnnouncer=new BackgroundSegmentAnnouncer(announcer,exec,config.getAnnounceIntervalMillis())){
    backgroundSegmentAnnouncer.startAnnouncing();
    final List<String> segmentFailures=Lists.newArrayList();
    for (    DataSegment segment : segments) {
      log.info("Loading segment %s",segment.getIdentifier());
      final boolean loaded;
      try {
        loaded=serverManager.loadSegment(segment);
      }
 catch (      Exception e) {
        log.error(e,"Exception loading segment[%s]",segment.getIdentifier());
        removeSegment(segment,callback);
        segmentFailures.add(segment.getIdentifier());
        continue;
      }
      if (loaded) {
        File segmentInfoCacheFile=new File(config.getInfoDir(),segment.getIdentifier());
        if (!segmentInfoCacheFile.exists()) {
          try {
            jsonMapper.writeValue(segmentInfoCacheFile,segment);
          }
 catch (          IOException e) {
            log.error(e,"Failed to write to disk segment info cache file[%s]",segmentInfoCacheFile);
            removeSegment(segment,callback);
            segmentFailures.add(segment.getIdentifier());
            continue;
          }
        }
        try {
          backgroundSegmentAnnouncer.announceSegment(segment);
        }
 catch (        InterruptedException e) {
          throw new SegmentLoadingException(e,"Loading Interrupted");
        }
      }
    }
    if (!segmentFailures.isEmpty()) {
      for (      String segmentFailure : segmentFailures) {
        log.error("%s failed to load",segmentFailure);
      }
      throw new SegmentLoadingException("%,d errors seen while loading segments",segmentFailures.size());
    }
    backgroundSegmentAnnouncer.finishAnnouncing();
  }
 catch (  SegmentLoadingException e) {
    log.makeAlert(e,"Failed to load segments").addData("segments",segments).emit();
  }
 finally {
    callback.execute();
  }
}
