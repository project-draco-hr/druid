{
  if (adapter == null) {
    throw new ISE("Null storage adapter found. Probably trying to issue a query against a segment being memory unmapped.");
  }
  return QueryRunnerHelper.makeCursorBasedQuery(adapter,query.getQuerySegmentSpec().getIntervals(),Filters.convertDimensionFilters(query.getDimensionsFilter()),query.getGranularity(),new Function<Cursor,Result<TimeseriesResultValue>>(){
    private final List<AggregatorFactory> aggregatorSpecs=query.getAggregatorSpecs();
    @Override public Result<TimeseriesResultValue> apply(    Cursor cursor){
      Aggregator[] aggregators=QueryRunnerHelper.makeAggregators(cursor,aggregatorSpecs);
      while (!cursor.isDone()) {
        for (        Aggregator aggregator : aggregators) {
          aggregator.aggregate();
        }
        cursor.advance();
      }
      TimeseriesResultBuilder bob=new TimeseriesResultBuilder(cursor.getTime());
      for (      Aggregator aggregator : aggregators) {
        bob.addMetric(aggregator);
      }
      Result<TimeseriesResultValue> retVal=bob.build();
      for (      Aggregator agg : aggregators) {
        agg.close();
      }
      return retVal;
    }
  }
);
}
