{
  final long truncatedNow=segmentGranularity.truncate(new DateTime()).getMillis();
  final long end=segmentGranularity.increment(truncatedNow) + windowMillis;
  final Duration timeUntilShutdown=new Duration(System.currentTimeMillis(),end);
  log.info("Shutting down in %s. Time at shutdown: ~%s",timeUntilShutdown,new DateTime(end));
  ScheduledExecutors.scheduleWithFixedDelay(scheduledExecutor,timeUntilShutdown,new Callable<ScheduledExecutors.Signal>(){
    @Override public ScheduledExecutors.Signal call() throws Exception {
      try {
        hasMore.set(false);
      }
 catch (      Exception e) {
        throw Throwables.propagate(e);
      }
      return ScheduledExecutors.Signal.STOP;
    }
  }
);
  shutdown=true;
}
