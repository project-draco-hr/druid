{
  if (extractionFn == null) {
    return selector.getBitmapFactory().union(Iterables.transform(values,new Function<String,ImmutableBitmap>(){
      @Override public ImmutableBitmap apply(      String value){
        return selector.getBitmapIndex(dimension,value);
      }
    }
));
  }
 else {
    Iterable<String> allDimVals=selector.getDimensionValues(dimension);
    if (allDimVals == null) {
      allDimVals=Lists.newArrayList((String)null);
    }
    List<ImmutableBitmap> bitmaps=Lists.newArrayList();
    for (    String dimVal : allDimVals) {
      if (values.contains(Strings.nullToEmpty(extractionFn.apply(dimVal)))) {
        bitmaps.add(selector.getBitmapIndex(dimension,dimVal));
      }
    }
    return selector.getBitmapFactory().union(bitmaps);
  }
}
