{
  Map<String,Rule> lookup=Maps.newHashMap();
  for (  DataSegment segment : segments) {
    for (    Rule rule : ruleMap.getRules(segment.getDataSource())) {
      if (rule.appliesTo(segment)) {
        lookup.put(segment.getIdentifier(),rule);
        break;
      }
    }
    if (!lookup.containsKey(segment.getIdentifier())) {
      throw new ISE("Unable to find a rule for [%s]!!!",segment.getIdentifier());
    }
  }
  return new SegmentRuleLookup(lookup);
}
