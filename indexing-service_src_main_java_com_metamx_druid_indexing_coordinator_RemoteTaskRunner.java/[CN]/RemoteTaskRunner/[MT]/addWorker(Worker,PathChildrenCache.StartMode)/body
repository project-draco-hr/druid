{
  log.info("Worker[%s] reportin' for duty!",worker.getHost());
  try {
    final String workerStatusPath=JOINER.join(config.getIndexerStatusPath(),worker.getHost());
    final PathChildrenCache statusCache=pathChildrenCacheFactory.make(cf,workerStatusPath);
    final ZkWorker zkWorker=new ZkWorker(worker,statusCache,jsonMapper);
    zkWorker.addListener(new PathChildrenCacheListener(){
      @Override public void childEvent(      CuratorFramework client,      PathChildrenCacheEvent event) throws Exception {
        String taskId;
        RemoteTaskRunnerWorkItem taskRunnerWorkItem;
synchronized (statusLock) {
          try {
switch (event.getType()) {
case CHILD_ADDED:
case CHILD_UPDATED:
              taskId=ZKPaths.getNodeFromPath(event.getData().getPath());
            final TaskStatus taskStatus=jsonMapper.readValue(event.getData().getData(),TaskStatus.class);
          log.info("Worker[%s] wrote %s status for task: %s",zkWorker.getWorker().getHost(),taskStatus.getStatusCode(),taskId);
        statusLock.notify();
      taskRunnerWorkItem=runningTasks.get(taskId);
    if (taskRunnerWorkItem == null) {
      log.warn("WTF?! Worker[%s] announcing a status for a task I didn't know about: %s",zkWorker.getWorker().getHost(),taskId);
    }
  if (taskStatus.isComplete()) {
    taskComplete(taskRunnerWorkItem,zkWorker,taskId,taskStatus);
    runPendingTasks();
  }
break;
case CHILD_REMOVED:
taskId=ZKPaths.getNodeFromPath(event.getData().getPath());
taskRunnerWorkItem=runningTasks.get(taskId);
if (taskRunnerWorkItem != null) {
log.info("Task[%s] just disappeared!",taskId);
taskRunnerWorkItem.setResult(TaskStatus.failure(taskRunnerWorkItem.getTask().getId()));
}
 else {
log.warn("Task[%s] just disappeared but I didn't know about it?!",taskId);
}
break;
}
}
 catch (Exception e) {
log.makeAlert(e,"Failed to handle new worker status").addData("worker",zkWorker.getWorker().getHost()).addData("znode",event.getData().getPath()).emit();
}
}
}
}
);
zkWorker.start(startMode);
zkWorkers.put(worker.getHost(),zkWorker);
runPendingTasks();
return zkWorker;
}
 catch (Exception e) {
throw Throwables.propagate(e);
}
}
