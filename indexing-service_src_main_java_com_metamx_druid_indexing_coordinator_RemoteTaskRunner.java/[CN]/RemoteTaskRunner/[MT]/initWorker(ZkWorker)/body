{
  try {
    zkWorker.addListener(new PathChildrenCacheListener(){
      @Override public void childEvent(      CuratorFramework client,      PathChildrenCacheEvent event) throws Exception {
synchronized (statusLock) {
          try {
            if (event.getType().equals(PathChildrenCacheEvent.Type.CHILD_ADDED) || event.getType().equals(PathChildrenCacheEvent.Type.CHILD_UPDATED)) {
              final String taskId=ZKPaths.getNodeFromPath(event.getData().getPath());
              final TaskStatus taskStatus=jsonMapper.readValue(event.getData().getData(),TaskStatus.class);
              log.info("Worker[%s] wrote %s status for task: %s",zkWorker.getWorker().getHost(),taskStatus.getStatusCode(),taskId);
              statusLock.notify();
              final TaskRunnerWorkItem taskRunnerWorkItem=runningTasks.get(taskId);
              if (taskRunnerWorkItem == null) {
                log.warn("WTF?! Worker[%s] announcing a status for a task I didn't know about: %s",zkWorker.getWorker().getHost(),taskId);
              }
 else {
                zkWorker.addRunningTask(taskRunnerWorkItem.getTask());
              }
              if (taskStatus.isComplete()) {
                if (taskRunnerWorkItem != null) {
                  final ListenableFuture<TaskStatus> result=taskRunnerWorkItem.getResult();
                  if (result != null) {
                    ((SettableFuture<TaskStatus>)result).set(taskStatus);
                  }
                  zkWorker.removeRunningTask(taskRunnerWorkItem.getTask());
                }
                zkWorker.setLastCompletedTaskTime(new DateTime());
                cleanup(zkWorker.getWorker().getHost(),taskId);
                runPendingTasks();
              }
            }
 else             if (event.getType().equals(PathChildrenCacheEvent.Type.CHILD_REMOVED)) {
              final String taskId=ZKPaths.getNodeFromPath(event.getData().getPath());
              TaskRunnerWorkItem taskRunnerWorkItem=runningTasks.get(taskId);
              if (taskRunnerWorkItem != null) {
                log.info("Task %s just disappeared!",taskId);
                failTask(taskRunnerWorkItem);
              }
            }
          }
 catch (          Exception e) {
            log.makeAlert(e,"Failed to handle new worker status").addData("worker",zkWorker.getWorker().getHost()).addData("znode",event.getData().getPath()).emit();
          }
        }
      }
    }
);
    zkWorker.start();
  }
 catch (  Exception e) {
    throw Throwables.propagate(e);
  }
}
