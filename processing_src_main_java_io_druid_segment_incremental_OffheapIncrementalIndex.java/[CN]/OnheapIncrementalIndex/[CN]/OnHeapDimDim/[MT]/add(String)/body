{
synchronized (lock) {
    Integer prev=valueToId.get(value);
    if (prev != null) {
      return prev;
    }
    final int index=size();
    valueToId.put(value,index);
    idToValue.add(value);
    return index;
  }
}
