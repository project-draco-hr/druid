{
  log.info("SETUP CALLED AT " + +System.currentTimeMillis());
  if (ComplexMetrics.getSerdeForType("hyperUnique") == null) {
    ComplexMetrics.registerSerde("hyperUnique",new HyperUniquesSerde(Hashing.murmur3_128()));
  }
  executorService=Execs.multiThreaded(numSegments,"GroupByThreadPool");
  setupQueries();
  String[] schemaQuery=schemaAndQuery.split("\\.");
  String schemaName=schemaQuery[0];
  String queryName=schemaQuery[1];
  schemaInfo=BenchmarkSchemas.SCHEMA_MAP.get(schemaName);
  query=SCHEMA_QUERY_MAP.get(schemaName).get(queryName);
  incIndexes=new ArrayList<>();
  for (int i=0; i < numSegments; i++) {
    log.info("Generating rows for segment " + i);
    BenchmarkDataGenerator gen=new BenchmarkDataGenerator(schemaInfo.getColumnSchemas(),RNG_SEED + 1,schemaInfo.getDataInterval(),rowsPerSegment);
    IncrementalIndex incIndex=makeIncIndex();
    incIndexes.add(incIndex);
    for (int j=0; j < rowsPerSegment; j++) {
      InputRow row=gen.nextRow();
      if (j % 10000 == 0) {
        log.info(j + " rows generated.");
      }
      incIndex.add(row);
    }
    log.info(rowsPerSegment + " rows generated");
  }
  IncrementalIndex incIndex=incIndexes.get(0);
  File tmpFile=Files.createTempDir();
  log.info("Using temp dir: " + tmpFile.getAbsolutePath());
  tmpFile.deleteOnExit();
  qIndexes=new ArrayList<>();
  for (int i=0; i < numSegments; i++) {
    File indexFile=INDEX_MERGER_V9.persist(incIndex,tmpFile,new IndexSpec());
    QueryableIndex qIndex=INDEX_IO.loadIndex(indexFile);
    qIndexes.add(qIndex);
  }
  OffheapBufferPool bufferPool=new OffheapBufferPool(250000000,Integer.MAX_VALUE);
  OffheapBufferPool bufferPool2=new OffheapBufferPool(250000000,Integer.MAX_VALUE);
  final GroupByQueryConfig config=new GroupByQueryConfig();
  config.setSingleThreaded(false);
  config.setMaxIntermediateRows(1000000);
  config.setMaxResults(1000000);
  final Supplier<GroupByQueryConfig> configSupplier=Suppliers.ofInstance(config);
  final GroupByQueryEngine engine=new GroupByQueryEngine(configSupplier,bufferPool);
  factory=new GroupByQueryRunnerFactory(engine,QueryBenchmarkUtil.NOOP_QUERYWATCHER,configSupplier,new GroupByQueryQueryToolChest(configSupplier,JSON_MAPPER,engine,bufferPool2,QueryBenchmarkUtil.NoopIntervalChunkingQueryRunnerDecorator()),bufferPool2);
}
