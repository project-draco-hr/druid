{
  EasyMock.expect(druidServer1.getName()).andReturn("1").atLeastOnce();
  EasyMock.expect(druidServer1.getCurrSize()).andReturn(30L).atLeastOnce();
  EasyMock.expect(druidServer1.getMaxSize()).andReturn(100L).atLeastOnce();
  EasyMock.expect(druidServer1.getDataSources()).andReturn(Arrays.asList(dataSource)).anyTimes();
  EasyMock.expect(druidServer1.getSegments()).andReturn(segments).anyTimes();
  EasyMock.replay(druidServer1);
  EasyMock.expect(druidServer2.getName()).andReturn("2").atLeastOnce();
  EasyMock.expect(druidServer2.getTier()).andReturn("normal").anyTimes();
  EasyMock.expect(druidServer2.getCurrSize()).andReturn(0L).atLeastOnce();
  EasyMock.expect(druidServer2.getMaxSize()).andReturn(100L).atLeastOnce();
  EasyMock.expect(druidServer2.getSegments()).andReturn(new HashMap<String,DataSegment>()).anyTimes();
  EasyMock.expect(druidServer2.getDataSources()).andReturn(Arrays.asList(dataSource)).anyTimes();
  EasyMock.expect(druidServer2.getSegment("datasource1_2012-01-01T00:00:00.000Z_2012-01-01T01:00:00.000Z_2012-03-01T00:00:00.000Z")).andReturn(null).anyTimes();
  EasyMock.expect(druidServer2.getSegment("datasource1_2012-02-01T00:00:00.000Z_2012-02-01T01:00:00.000Z_2012-03-01T00:00:00.000Z")).andReturn(null).anyTimes();
  EasyMock.expect(druidServer2.getSegment("datasource2_2012-01-01T00:00:00.000Z_2012-01-01T01:00:00.000Z_2012-03-01T00:00:00.000Z")).andReturn(null).anyTimes();
  EasyMock.expect(druidServer2.getSegment("datasource2_2012-02-01T00:00:00.000Z_2012-02-01T01:00:00.000Z_2012-03-01T00:00:00.000Z")).andReturn(null).anyTimes();
  EasyMock.replay(druidServer2);
  EasyMock.expect(druidServer3.getName()).andReturn("3").atLeastOnce();
  EasyMock.expect(druidServer3.getTier()).andReturn("normal").anyTimes();
  EasyMock.expect(druidServer3.getCurrSize()).andReturn(0L).atLeastOnce();
  EasyMock.expect(druidServer3.getMaxSize()).andReturn(100L).atLeastOnce();
  EasyMock.expect(druidServer3.getSegments()).andReturn(new HashMap<String,DataSegment>()).anyTimes();
  EasyMock.expect(druidServer3.getDataSources()).andReturn(Arrays.asList(dataSource)).anyTimes();
  EasyMock.expect(druidServer3.getSegment("datasource1_2012-01-01T00:00:00.000Z_2012-01-01T01:00:00.000Z_2012-03-01T00:00:00.000Z")).andReturn(null).anyTimes();
  EasyMock.expect(druidServer3.getSegment("datasource1_2012-02-01T00:00:00.000Z_2012-02-01T01:00:00.000Z_2012-03-01T00:00:00.000Z")).andReturn(null).anyTimes();
  EasyMock.expect(druidServer3.getSegment("datasource2_2012-01-01T00:00:00.000Z_2012-01-01T01:00:00.000Z_2012-03-01T00:00:00.000Z")).andReturn(null).anyTimes();
  EasyMock.expect(druidServer3.getSegment("datasource2_2012-02-01T00:00:00.000Z_2012-02-01T01:00:00.000Z_2012-03-01T00:00:00.000Z")).andReturn(null).anyTimes();
  EasyMock.replay(druidServer3);
  EasyMock.expect(druidServer4.getName()).andReturn("4").atLeastOnce();
  EasyMock.expect(druidServer4.getTier()).andReturn("normal").anyTimes();
  EasyMock.expect(druidServer4.getCurrSize()).andReturn(0L).atLeastOnce();
  EasyMock.expect(druidServer4.getMaxSize()).andReturn(100L).atLeastOnce();
  EasyMock.expect(druidServer4.getSegments()).andReturn(new HashMap<String,DataSegment>()).anyTimes();
  EasyMock.expect(druidServer4.getDataSources()).andReturn(Arrays.asList(dataSource)).anyTimes();
  EasyMock.expect(druidServer4.getSegment("datasource1_2012-01-01T00:00:00.000Z_2012-01-01T01:00:00.000Z_2012-03-01T00:00:00.000Z")).andReturn(null).anyTimes();
  EasyMock.expect(druidServer4.getSegment("datasource1_2012-02-01T00:00:00.000Z_2012-02-01T01:00:00.000Z_2012-03-01T00:00:00.000Z")).andReturn(null).anyTimes();
  EasyMock.expect(druidServer4.getSegment("datasource2_2012-01-01T00:00:00.000Z_2012-01-01T01:00:00.000Z_2012-03-01T00:00:00.000Z")).andReturn(null).anyTimes();
  EasyMock.expect(druidServer4.getSegment("datasource2_2012-02-01T00:00:00.000Z_2012-02-01T01:00:00.000Z_2012-03-01T00:00:00.000Z")).andReturn(null).anyTimes();
  EasyMock.replay(druidServer4);
  EasyMock.expect(dataSource.getSegments()).andReturn(Sets.<DataSegment>newHashSet(segment1,segment2,segment3,segment4)).anyTimes();
  EasyMock.replay(dataSource);
  master.moveSegment(EasyMock.<String>anyObject(),EasyMock.<String>anyObject(),EasyMock.<String>anyObject(),EasyMock.<LoadPeonCallback>anyObject());
  EasyMock.expectLastCall().atLeastOnce();
  EasyMock.replay(master);
  EasyMock.expect(peon.getLoadQueueSize()).andReturn(0L).atLeastOnce();
  EasyMock.expect(peon.getSegmentsToLoad()).andReturn(Sets.<DataSegment>newHashSet()).atLeastOnce();
  EasyMock.replay(peon);
  DruidMasterRuntimeParams params=DruidMasterRuntimeParams.newBuilder().withDruidCluster(new DruidCluster(ImmutableMap.<String,MinMaxPriorityQueue<ServerHolder>>of("normal",MinMaxPriorityQueue.orderedBy(DruidMasterBalancer.percentUsedComparator).create(Arrays.asList(new ServerHolder(druidServer1,peon),new ServerHolder(druidServer2,peon),new ServerHolder(druidServer3,peon),new ServerHolder(druidServer4,peon)))))).withLoadManagementPeons(ImmutableMap.of("1",peon,"2",peon,"3",peon,"4",peon)).withAvailableSegments(segments.values()).withMaxSegmentsToMove(MAX_SEGMENTS_TO_MOVE).withBalancerReferenceTimestamp(new DateTime("2013-01-01")).build();
  params=new DruidMasterBalancer(master).run(params);
  Assert.assertTrue(params.getMasterStats().getPerTierStats().get("movedCount").get("normal").get() > 0);
}
