{
  giant.lock();
  try {
    Preconditions.checkNotNull(task,"task");
    Preconditions.checkNotNull(originalStatus,"status");
    Preconditions.checkState(active,"Queue is not active!");
    Preconditions.checkArgument(task.getId().equals(originalStatus.getId()),"Mismatching task ids[%s/%s]",task.getId(),originalStatus.getId());
    final TaskGroup taskGroup;
    final Optional<TaskGroup> maybeTaskGroup=findTaskGroupForTask(task);
    if (!maybeTaskGroup.isPresent()) {
      log.info("Ignoring notification for dead task: %s",task.getId());
      return;
    }
 else {
      taskGroup=maybeTaskGroup.get();
    }
    TaskStatus statusToSave=originalStatus;
    if (taskGroup.getCommitStyle().shouldCommit(task,statusToSave)) {
      log.info("Committing %s status for task: %s",statusToSave.getStatusCode(),task.getId());
      try {
        if (commitRunnable != null) {
          log.info("Running commitRunnable for task: %s",task.getId());
          commitRunnable.run();
        }
        for (        final Task nextTask : statusToSave.getNextTasks()) {
          try {
            add(nextTask);
          }
 catch (          TaskExistsException e) {
            log.info("Already added followup task %s to original task: %s",nextTask.getId(),task.getId());
          }
        }
      }
 catch (      Exception e) {
        log.makeAlert(e,"Failed to commit task").addData("task",task.getId()).addData("statusCode",statusToSave.getStatusCode()).emit();
        statusToSave=TaskStatus.failure(task.getId()).withDuration(statusToSave.getDuration());
      }
    }
 else {
      log.info("Not committing %s status for task: %s",statusToSave.getStatusCode(),task);
    }
    boolean didSetStatus=false;
    try {
      taskStorage.setStatus(task.getId(),statusToSave);
      didSetStatus=true;
    }
 catch (    Exception e) {
      log.warn(e,"Status could not be persisted! Reinserting task: %s",task.getId());
      log.makeAlert(e,"Failed to persist task status").addData("task",task.getId()).addData("statusCode",statusToSave.getStatusCode()).emit();
      queue.add(task);
    }
    if (didSetStatus && statusToSave.isComplete()) {
      unlock(task);
      log.info("Task done: %s",task);
    }
  }
  finally {
    giant.unlock();
  }
}
