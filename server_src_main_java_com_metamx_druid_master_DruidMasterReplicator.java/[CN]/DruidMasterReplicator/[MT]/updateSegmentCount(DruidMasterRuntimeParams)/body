{
  Map<String,ReplicatorSegmentHolder> allSegments=Maps.newHashMap();
  Collection<DruidServer> servers=params.getHistoricalServers();
  if (servers.size() <= 1) {
    log.warn("Number of servers[%,d]: nothing to replicate",servers.size());
    return;
  }
  for (  DruidServer server : servers) {
    for (    DruidDataSource dataSource : server.getDataSources()) {
      for (      DataSegment segment : dataSource.getSegments()) {
        String key=segment.getIdentifier();
        ReplicatorSegmentHolder holder=new ReplicatorSegmentHolder(server,segment);
        if (params.getAvailableSegments().contains(segment)) {
          if (allSegments.containsKey(key)) {
            allSegments.get(key).update(server);
          }
 else {
            allSegments.put(key,holder);
          }
        }
      }
    }
  }
  for (  ReplicatorSegmentHolder holder : allSegments.values()) {
    if ((holder.getCount() < MAX_NUM_SEGMENTS) && (segmentsToClone.size() < MAX_TOTAL_REPLICANTS_CREATED)) {
      segmentsToClone.add(holder);
    }
 else     if ((holder.getCount() > MAX_NUM_SEGMENTS) && (segmentsToDrop.size() < MAX_TOTAL_REPLICANTS_DESTROYED)) {
      segmentsToDrop.add(holder);
    }
  }
}
