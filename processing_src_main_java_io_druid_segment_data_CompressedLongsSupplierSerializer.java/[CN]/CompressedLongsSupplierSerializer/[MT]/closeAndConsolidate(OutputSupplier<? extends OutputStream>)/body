{
  endBuffer.limit(endBuffer.position());
  endBuffer.rewind();
  flattener.write(StupidResourceHolder.create(endBuffer));
  endBuffer=null;
  flattener.close();
  try (OutputStream out=consolidatedOut.getOutput()){
    out.write(CompressedLongsIndexedSupplier.version);
    out.write(Ints.toByteArray(numInserted));
    out.write(Ints.toByteArray(sizePer));
    out.write(new byte[]{compression.getId()});
    ByteStreams.copy(flattener.combineStreams(),out);
  }
 }
