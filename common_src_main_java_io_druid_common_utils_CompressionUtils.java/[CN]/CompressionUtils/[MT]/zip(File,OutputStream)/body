{
  if (!directory.isDirectory()) {
    throw new IOException(String.format("directory[%s] is not a directory",directory));
  }
  long totalSize=0;
  ZipOutputStream zipOut=null;
  try {
    zipOut=new ZipOutputStream(out);
    File[] files=directory.listFiles();
    for (    File file : files) {
      log.info("Adding file[%s] with size[%,d].  Total size so far[%,d]",file,file.length(),totalSize);
      if (file.length() >= Integer.MAX_VALUE) {
        zipOut.finish();
        throw new IOException(String.format("file[%s] too large [%,d]",file,file.length()));
      }
      zipOut.putNextEntry(new ZipEntry(file.getName()));
      totalSize+=ByteStreams.copy(Files.newInputStreamSupplier(file),zipOut);
    }
    zipOut.closeEntry();
  }
  finally {
    if (zipOut != null) {
      zipOut.finish();
    }
  }
  return totalSize;
}
