{
  if (!directory.isDirectory()) {
    throw new IOException(String.format("directory[%s] is not a directory",directory));
  }
  if (!outputZipFile.getName().endsWith(".zip")) {
    log.warn("No .zip suffix[%s], putting files from [%s] into it anyway.",outputZipFile,directory);
  }
  long totalSize=0;
  ZipOutputStream zipOut=null;
  try {
    zipOut=new ZipOutputStream(new FileOutputStream(outputZipFile));
    File[] files=directory.listFiles();
    for (    File file : files) {
      log.info("Adding file[%s] with size[%,d].  Total size so far[%,d]",file,file.length(),totalSize);
      if (file.length() >= Integer.MAX_VALUE) {
        zipOut.close();
        outputZipFile.delete();
        throw new IOException(String.format("file[%s] too large [%,d]",file,file.length()));
      }
      zipOut.putNextEntry(new ZipEntry(file.getName()));
      totalSize+=ByteStreams.copy(Files.newInputStreamSupplier(file),zipOut);
    }
  }
  finally {
    Closeables.closeQuietly(zipOut);
  }
  return totalSize;
}
