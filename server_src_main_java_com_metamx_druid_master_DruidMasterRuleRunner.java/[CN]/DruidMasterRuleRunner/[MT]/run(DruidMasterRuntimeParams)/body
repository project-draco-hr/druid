{
  MasterStats stats=new MasterStats();
  DruidCluster cluster=params.getDruidCluster();
  if (cluster.isEmpty()) {
    log.warn("Uh... I have no servers. Not assigning anything...");
    return params;
  }
  DatabaseRuleManager databaseRuleManager=params.getDatabaseRuleManager();
  for (  DataSegment segment : params.getAvailableSegments()) {
    List<Rule> rules=databaseRuleManager.getRulesWithDefault(segment.getDataSource());
    boolean foundMatchingRule=false;
    for (    Rule rule : rules) {
      if (rule.appliesTo(segment)) {
        stats.accumulate(rule.run(master,params,segment));
        foundMatchingRule=true;
        break;
      }
    }
    if (!foundMatchingRule) {
      log.makeAlert("Unable to find a matching rule for segment[%s]",segment.getIdentifier()).emit();
    }
  }
  return params.buildFromExisting().withMasterStats(stats).build();
}
