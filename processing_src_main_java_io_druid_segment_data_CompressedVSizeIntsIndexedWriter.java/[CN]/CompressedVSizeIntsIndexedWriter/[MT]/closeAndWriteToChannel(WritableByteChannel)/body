{
  if (numInserted > 0) {
    endBuffer.limit(endBuffer.position());
    endBuffer.rewind();
    flattener.write(StupidResourceHolder.create(endBuffer));
  }
  endBuffer=null;
  flattener.close();
  channel.write(ByteBuffer.wrap(new byte[]{version,(byte)numBytes}));
  channel.write(ByteBuffer.wrap(Ints.toByteArray(numInserted)));
  channel.write(ByteBuffer.wrap(Ints.toByteArray(chunkFactor)));
  channel.write(ByteBuffer.wrap(new byte[]{compression.getId()}));
  final ReadableByteChannel from=Channels.newChannel(flattener.combineStreams().getInput());
  long dataLen=ByteStreams.copy(from,channel);
  return 1 + 1 + Ints.BYTES+ Ints.BYTES+ 1+ dataLen;
}
