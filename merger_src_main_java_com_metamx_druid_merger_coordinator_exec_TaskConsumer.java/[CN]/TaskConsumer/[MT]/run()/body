{
  try {
    while (!Thread.currentThread().isInterrupted()) {
      final Task task;
      final String version;
      try {
        final VersionedTaskWrapper taskWrapper=queue.take();
        task=taskWrapper.getTask();
        version=taskWrapper.getVersion();
      }
 catch (      InterruptedException e) {
        log.info(e,"Interrupted while waiting for new work");
        throw e;
      }
      try {
        handoff(task,version);
      }
 catch (      Exception e) {
        log.makeAlert(e,"Failed to hand off task").addData("task",task.getId()).addData("type",task.getType().toString()).addData("dataSource",task.getDataSource()).addData("interval",task.getInterval()).emit();
        if (!shutdown) {
          queue.notify(task,TaskStatus.failure(task.getId()));
        }
      }
    }
  }
 catch (  Exception e) {
    log.error(e,"Uncaught exception while consuming tasks");
    throw Throwables.propagate(e);
  }
}
