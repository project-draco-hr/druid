{
  initializeWarehouse();
  initializeBrokerHttpClient();
  initializeCacheBroker();
  initializeDiscovery();
  final Lifecycle lifecycle=getLifecycle();
  final List<Monitor> monitors=getMonitors();
  monitors.add(new CacheMonitor(cache));
  startMonitoring(monitors);
  final ExecutorService viewExec=Executors.newFixedThreadPool(1,new ThreadFactoryBuilder().setDaemon(true).setNameFormat("BrokerServerView-%s").build());
  final BrokerServerView view=new BrokerServerView(warehouse,getSmileMapper(),brokerHttpClient,getServerInventoryView(),viewExec);
  final CachingClusteredClient baseClient=new CachingClusteredClient(warehouse,view,cache,getSmileMapper());
  lifecycle.addManagedInstance(baseClient);
  final ClientQuerySegmentWalker texasRanger=new ClientQuerySegmentWalker(warehouse,getEmitter(),baseClient);
  List<Module> theModules=Lists.newArrayList();
  theModules.add(new ClientServletModule(texasRanger,getServerInventoryView(),getJsonMapper()));
  theModules.addAll(extraModules);
  final Injector injector=Guice.createInjector(theModules);
  final Context root=new Context(getServer(),"/",Context.SESSIONS);
  root.addServlet(new ServletHolder(new StatusServlet()),"/status");
  root.addServlet(new ServletHolder(new QueryServlet(getJsonMapper(),getSmileMapper(),texasRanger,getEmitter(),getRequestLogger())),"/druid/v2/*");
  root.addEventListener(new GuiceServletConfig(injector));
  root.addFilter(GuiceFilter.class,"/druid/v2/datasources/*",0);
  for (  String path : pathsForGuiceFilter) {
    root.addFilter(GuiceFilter.class,path,0);
  }
}
