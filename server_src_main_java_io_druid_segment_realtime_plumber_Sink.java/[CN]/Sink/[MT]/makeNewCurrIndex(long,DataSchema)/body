{
  int aggsSize=0;
  for (  AggregatorFactory agg : schema.getAggregators()) {
    aggsSize+=agg.getMaxIntermediateSize();
  }
  int bufferSize=aggsSize * config.getMaxRowsInMemory();
  final IncrementalIndexSchema indexSchema=new IncrementalIndexSchema.Builder().withMinTimestamp(minTimestamp).withQueryGranularity(schema.getGranularitySpec().getQueryGranularity()).withDimensionsSpec(schema.getParser()).withMetrics(schema.getAggregators()).build();
  final IncrementalIndex newIndex;
  if (config.isIngestOffheap()) {
    newIndex=new OffheapIncrementalIndex(indexSchema,new OffheapBufferPool(bufferSize),true);
  }
 else {
    newIndex=new OnheapIncrementalIndex(indexSchema);
  }
  final FireHydrant old;
synchronized (hydrantLock) {
    old=currHydrant;
    currHydrant=new FireHydrant(newIndex,hydrants.size(),getSegment().getIdentifier());
    hydrants.add(currHydrant);
  }
  return old;
}
