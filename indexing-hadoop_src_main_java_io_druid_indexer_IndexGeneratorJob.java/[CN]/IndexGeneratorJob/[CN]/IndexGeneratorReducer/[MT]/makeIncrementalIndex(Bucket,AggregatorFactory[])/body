{
  final HadoopTuningConfig tuningConfig=config.getSchema().getTuningConfig();
  final IncrementalIndexSchema indexSchema=new IncrementalIndexSchema.Builder().withMinTimestamp(theBucket.time.getMillis()).withDimensionsSpec(config.getSchema().getDataSchema().getParser()).withQueryGranularity(config.getSchema().getDataSchema().getGranularitySpec().getQueryGranularity()).withMetrics(aggs).build();
  if (tuningConfig.isIngestOffheap()) {
    final int maxTotalBufferSize=tuningConfig.getBufferSize();
    final int aggregationBufferSize=(int)((double)maxTotalBufferSize * tuningConfig.getAggregationBufferRatio());
    return new OffheapIncrementalIndex(indexSchema,new OffheapBufferPool(aggregationBufferSize),true,maxTotalBufferSize);
  }
 else {
    return new OnheapIncrementalIndex(indexSchema,tuningConfig.getRowFlushBoundary());
  }
}
