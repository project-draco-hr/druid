{
  SQLMetadataStorageActionHandler<Map<String,Integer>,Map<String,Integer>,Map<String,Integer>,Map<String,Integer>> handler=new SQLMetadataStorageActionHandler(connector,tablesConfig,jsonMapper,new MetadataStorageActionHandlerTypes(){
    @Override public TypeReference getTaskType(){
      return new TypeReference<Map<String,Integer>>(){
      }
;
    }
    @Override public TypeReference getTaskStatusType(){
      return new TypeReference<Map<String,Integer>>(){
      }
;
    }
    @Override public TypeReference getTaskActionType(){
      return new TypeReference<Map<String,Integer>>(){
      }
;
    }
    @Override public TypeReference getTaskLockType(){
      return new TypeReference<Map<String,Integer>>(){
      }
;
    }
  }
);
  Map<String,Integer> task=ImmutableMap.of("taskId",1);
  Map<String,Integer> taskStatus=ImmutableMap.of("count",42);
  Map<String,Integer> taskStatus2=ImmutableMap.of("count",42,"temp",1);
  connector.createTaskTables();
  final String taskId="1234";
  handler.insert(taskId,new DateTime("2014-01-02T00:00:00.123"),"testDataSource",task,true,taskStatus);
  Assert.assertEquals(Optional.of(task),handler.getTask(taskId));
  Assert.assertEquals(ImmutableList.of(Pair.of(task,taskStatus)),handler.getActiveTasksWithStatus());
  Assert.assertTrue(handler.setStatus(taskId,true,taskStatus2));
  Assert.assertEquals(ImmutableList.of(Pair.of(task,taskStatus2)),handler.getActiveTasksWithStatus());
  Assert.assertEquals(ImmutableList.of(),handler.getRecentlyFinishedTaskStatuses(new DateTime("2014-01-01")));
  Assert.assertTrue(handler.setStatus(taskId,false,taskStatus));
  Assert.assertEquals(Optional.of(taskStatus),handler.getTaskStatus(taskId));
  Assert.assertFalse(handler.setStatus(taskId,false,taskStatus2));
  Assert.assertEquals(Optional.of(taskStatus),handler.getTaskStatus(taskId));
  Assert.assertEquals(Optional.of(task),handler.getTask(taskId));
  Assert.assertEquals(ImmutableList.of(),handler.getRecentlyFinishedTaskStatuses(new DateTime("2014-01-03")));
  Assert.assertEquals(ImmutableList.of(taskStatus),handler.getRecentlyFinishedTaskStatuses(new DateTime("2014-01-01")));
}
