{
  if (resourceManagementSchedulerFactory == null) {
    resourceManagementSchedulerFactory=new ResourceManagementSchedulerFactory(){
      @Override public ResourceManagementScheduler build(      TaskRunner runner){
        final ScheduledExecutorService scalingScheduledExec=Executors.newScheduledThreadPool(1,new ThreadFactoryBuilder().setDaemon(true).setNameFormat("ScalingExec--%d").build());
        final AtomicReference<WorkerSetupData> workerSetupData=configManager.watch(WorkerSetupData.CONFIG_KEY,WorkerSetupData.class);
        AutoScalingStrategy strategy;
        if (config.getStrategyImpl().equalsIgnoreCase("ec2")) {
          strategy=new EC2AutoScalingStrategy(jsonMapper,new AmazonEC2Client(new BasicAWSCredentials(PropUtils.getProperty(props,"com.metamx.aws.accessKey"),PropUtils.getProperty(props,"com.metamx.aws.secretKey"))),configFactory.build(EC2AutoScalingStrategyConfig.class),workerSetupData);
        }
 else         if (config.getStrategyImpl().equalsIgnoreCase("noop")) {
          strategy=new NoopAutoScalingStrategy();
        }
 else {
          throw new ISE("Invalid strategy implementation: %s",config.getStrategyImpl());
        }
        return new ResourceManagementScheduler(runner,new SimpleResourceManagementStrategy(strategy,configFactory.build(SimpleResourceManagmentConfig.class),workerSetupData),configFactory.build(ResourceManagementSchedulerConfig.class),scalingScheduledExec);
      }
    }
;
  }
}
