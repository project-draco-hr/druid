{
  Timing timing=new Timing();
  CuratorFramework curator=CuratorFrameworkFactory.builder().connectString(server.getConnectString()).sessionTimeoutMs(timing.session()).connectionTimeoutMs(timing.connection()).retryPolicy(new RetryOneTime(1)).build();
  final ExecutorService exec=Execs.singleThreaded("test-announcer-sanity-%s");
  curator.start();
  Announcer announcer=new Announcer(curator,exec);
  try {
    curator.create().forPath("/somewhere");
    announcer.start();
    final byte[] billy="billy".getBytes();
    final String testPath1="/test1";
    final String testPath2="/somewhere/test2";
    final Set<String> paths=Sets.newHashSet(testPath1,testPath2);
    announcer.announce(testPath1,billy);
    announcer.announce(testPath2,billy);
    Assert.assertArrayEquals(billy,curator.getData().forPath(testPath1));
    Assert.assertArrayEquals(billy,curator.getData().forPath(testPath2));
    final CountDownLatch latch=new CountDownLatch(1);
    curator.getCuratorListenable().addListener(new CuratorListener(){
      @Override public void eventReceived(      CuratorFramework client,      CuratorEvent event) throws Exception {
        if (event.getType() == CuratorEventType.CREATE) {
          paths.remove(event.getPath());
          if (paths.isEmpty()) {
            latch.countDown();
          }
        }
      }
    }
);
    KillSession.kill(curator.getZookeeperClient().getZooKeeper(),server.getConnectString());
    timing.awaitLatch(latch);
    Assert.assertArrayEquals(billy,curator.getData().forPath(testPath1));
    Assert.assertArrayEquals(billy,curator.getData().forPath(testPath2));
    announcer.stop();
    Assert.assertNull(curator.checkExists().forPath(testPath1));
    Assert.assertNull(curator.checkExists().forPath(testPath2));
  }
  finally {
    announcer.stop();
    Closeables.closeQuietly(curator);
  }
}
