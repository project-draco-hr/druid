{
  return new QueryRunner<SegmentAnalysis>(){
    @Override public Sequence<SegmentAnalysis> run(    Query<SegmentAnalysis> inQ,    Map<String,Object> responseContext){
      SegmentMetadataQuery query=(SegmentMetadataQuery)inQ;
      final QueryableIndex index=segment.asQueryableIndex();
      final Map<String,ColumnAnalysis> analyzedColumns;
      long totalSize=0;
      if (index == null) {
        analyzedColumns=analyzer.analyze(segment.asStorageAdapter());
      }
 else {
        analyzedColumns=analyzer.analyze(index);
        totalSize=analyzedColumns.size() * index.getNumRows();
      }
      Map<String,ColumnAnalysis> columns=Maps.newTreeMap();
      ColumnIncluderator includerator=query.getToInclude();
      for (      Map.Entry<String,ColumnAnalysis> entry : analyzedColumns.entrySet()) {
        final String columnName=entry.getKey();
        final ColumnAnalysis column=entry.getValue();
        if (!column.isError()) {
          totalSize+=column.getSize();
        }
        if (includerator.include(columnName)) {
          columns.put(columnName,column);
        }
      }
      return Sequences.simple(Arrays.asList(new SegmentAnalysis(segment.getIdentifier(),Arrays.asList(segment.getDataInterval()),columns,totalSize)));
    }
  }
;
}
